<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>iMoon Stream â€¢ Vertical</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.1/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.js"></script>
  <style>
    html,body,#root{margin:0;width:100%;height:100%;overflow:hidden}
    canvas{display:block}
    #hud{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);font-family:monospace;font-size:16px}
  </style>
</head>
<body class="bg-black">
  <canvas id="c"></canvas>
  <div id="hud" class="text-lime-400/80"></div>

  <script>
    // ---- config fetch (same as landscape) ----
    const SUPA_URL  = "${SUPABASE_URL}";
    const SUPA_ANON = "${SUPABASE_ANON_KEY}";
    const TABLE     = "stream_cfg";

    const cfgParam = new URLSearchParams(location.search).get('cfg');
    let cfg = cfgParam ? JSON.parse(cfgParam) : null;

    async function getCfg(){
      if(cfg) return cfg;
      const sb = supabase.createClient(SUPA_URL, SUPA_ANON);
      const { data } = await sb.from(TABLE).select('*').limit(1).single();
      cfg = data || { bg:'stars', hue:'#4ade80', osc:'sine', bpm:40 };
      return cfg;
    }

    // ---- canvas setup ----
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');

    function resize(){
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // ---- simple starfield animation tuned for portrait ----
    const stars = Array.from({length:500}).map(()=>({
      x: Math.random(),
      y: Math.random(),
      r: Math.random()*2+0.4,
      s: Math.random()*0.7+0.2
    }));

    let start;
    function draw(ts){
      if(!start) start = ts;
      const t = (ts-start)/1000;
      ctx.fillStyle = '#000';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      stars.forEach(s => {
        const tw = (Math.sin(t*0.6 + s.s*8)+1)/2;
        ctx.beginPath();
        ctx.arc(s.x*canvas.width, s.y*canvas.height, s.r*tw, 0, Math.PI*2);
        ctx.fillStyle = '#fff';
        ctx.fill();
      });
      requestAnimationFrame(draw);
    }

    // ---- HUD (next full moon) ----
    const hud = document.getElementById('hud');
    function nextFullMoon(now=new Date()){
      const synodic = 29.53059*86400*1000;
      const phase = SunCalc.getMoonIllumination(now).phase;
      const diff = (phase>0.5?1.5-phase:0.5-phase)*synodic;
      return new Date(now.getTime()+diff);
    }
    function hudLoop(){
      const now = new Date();
      const full = nextFullMoon(now);
      const sec = Math.floor((full-now)/1000);
      const d = Math.floor(sec/86400), h = Math.floor(sec%86400/3600), m = Math.floor(sec%3600/60);
      hud.textContent = `Full moon in ${d}d ${h}h ${m}m`;
      requestAnimationFrame(hudLoop);
    }

    (async()=>{
      await getCfg();
      requestAnimationFrame(draw);
      hudLoop();
    })();
  </script>
</body>
</html>
